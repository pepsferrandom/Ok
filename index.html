<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Financiero PWA + Gemini AI</title>
    <meta name="description" content="Monitor de noticias financieras con glosario inteligente y an√°lisis AI.">
    <meta name="theme-color" content="#0f172a">

    <!-- 
    ============================================================================
    FinNews + AI (Versi√≥n 6.1 - Fix ReferenceError)
    ============================================================================
    CORRECCIONES:
    1.  FIX ERROR 'analyzer is not defined': Se ha reintegrado el objeto 'analyzer'
        que faltaba y es necesario para mostrar la relevancia de las noticias.
    2.  ESTABILIDAD: La aplicaci√≥n ahora carga correctamente las noticias sin
        detenerse por referencias perdidas.
    ============================================================================
    -->

    <style>
        :root {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --primary: #2563eb;
            --accent: #0f172a;
            --border: #e2e8f0;
            --highlight: #fef08a;
            --ai-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --modal-overlay: rgba(15, 23, 42, 0.7);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #0f172a;
                --bg-card: #1e293b;
                --text-main: #f1f5f9;
                --text-muted: #94a3b8;
                --primary: #3b82f6;
                --accent: #f8fafc;
                --border: #334155;
                --highlight: #854d0e;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-bottom: 80px; /* Espacio para el men√∫ de abajo */
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout */
        header {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        h1 { margin: 0; font-size: 1.25rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        .subtitle { font-size: 0.75rem; color: var(--text-muted); }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Buscador */
        .search-box {
            margin-bottom: 1.5rem;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--border);
            border-radius: 2rem;
            font-size: 1rem;
            background: var(--bg-card);
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            outline: none;
            box-sizing: border-box; 
        }
        .search-input:focus { border-color: var(--primary); }
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            fill: var(--text-muted);
            pointer-events: none;
        }

        /* Botones e Iconos */
        button {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        button:hover { background-color: var(--border); }
        button.primary { background-color: var(--primary); color: white; border: none; }
        button.primary:hover { opacity: 0.9; }
        
        button.ai-btn {
            background: var(--ai-gradient);
            color: white;
            border: none;
            font-weight: 600;
        }
        button.ai-btn:hover { filter: brightness(1.1); box-shadow: 0 2px 8px rgba(168, 85, 247, 0.4); }

        .icon { width: 20px; height: 20px; fill: currentColor; }

        /* Lista de Noticias */
        .news-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 1rem; }
        
        .news-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            cursor: pointer;
            position: relative; /* Para posicionar el bot√≥n de guardar */
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .news-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        /* Bot√≥n Guardar Noticia */
        .bookmark-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: transparent;
            border: none;
            padding: 0.25rem;
            color: var(--text-muted);
            z-index: 2;
        }
        .bookmark-btn.saved { color: #eab308; fill: #eab308; } /* Color amarillo al guardar */
        .bookmark-btn svg { width: 24px; height: 24px; }

        .meta { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; padding-right: 2rem;}
        .tag { background: var(--primary); color: white; padding: 0.1rem 0.4rem; border-radius: 4px; font-weight: bold; }
        .relevance { color: var(--primary); font-weight: 600; font-size: 0.75rem; margin-top: 0.5rem; display: block;}

        .news-title { font-size: 1.1rem; font-weight: 600; margin: 0 0 0.5rem 0; line-height: 1.4; }
        .news-summary { font-size: 0.9rem; color: var(--text-muted); display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        /* Men√∫ de Navegaci√≥n Inferior */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-card); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; padding: 0.75rem 0;
            z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            font-size: 0.75rem; color: var(--text-muted);
            background: none; border: none; padding: 0; gap: 4px;
        }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .nav-item svg { width: 24px; height: 24px; }

        /* Estilos Glosario */
        .term-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem;
            padding: 1rem; display: flex; justify-content: space-between; align-items: center;
        }
        .term-content { flex: 1; margin-right: 1rem; }
        .term-name { font-weight: 700; color: var(--primary); text-transform: capitalize; }
        .term-def { font-size: 0.9rem; color: var(--text-muted); margin-top: 0.25rem; }
        .delete-btn { color: #ef4444; border:none; background:none; }

        /* Vistas Modales */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-overlay);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: flex-end;
        }
        .modal.active { display: flex; }
        @media(min-width: 640px) { .modal { align-items: center; } }

        .modal-content {
            background: var(--bg-card);
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            border-radius: 1rem 1rem 0 0;
            padding: 1.5rem;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }
        @media(min-width: 640px) { .modal-content { border-radius: 1rem; height: auto; max-height: 85vh; } }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .close-btn { 
            position: absolute; top: 1rem; right: 1rem; 
            border: none; font-size: 1.5rem; padding: 0.2rem 0.5rem; 
            background: rgba(0,0,0,0.05); border-radius: 50%; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10;
        }
        .close-btn:hover { background: rgba(0,0,0,0.1); }

        .article-body { font-size: 1.05rem; line-height: 1.8; margin-bottom: 2rem; white-space: pre-wrap; }
        .highlight-term { background-color: var(--highlight); padding: 0 2px; border-radius: 2px; font-weight: 700; cursor: help; border-bottom: 1px dashed var(--text-muted); }
        
        .glossary-section {
            background: var(--bg-body);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary);
            margin-top: 2rem;
        }
        .glossary-title { font-weight: bold; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .glossary-item { margin-bottom: 0.75rem; font-size: 0.9rem; }
        .glossary-term { font-weight: 700; color: var(--primary); }

        .ai-analysis-box {
            background: #f3e8ff; border: 1px solid #d8b4fe;
            border-radius: 0.5rem; padding: 1rem;
            margin-bottom: 1.5rem; font-size: 0.95rem;
            color: #4c1d95; display: none;
        }
        .dark .ai-analysis-box { background: #2e1065; border-color: #581c87; color: #e9d5ff; }
        .ai-title { font-weight: bold; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; color: #7e22ce; }
        .dark .ai-title { color: #d8b4fe; }

        .config-group { margin-bottom: 1rem; }
        .config-group label { display: block; font-weight: 600; margin-bottom: 0.25rem; }
        .config-input { width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.25rem; background: var(--bg-body); color: var(--text-main); }
        .source-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }

        .hidden { display: none !important; }
        .loader { text-align: center; padding: 2rem; color: var(--text-muted); }
        .status-bar { font-size: 0.75rem; text-align: center; padding: 0.5rem; background: var(--bg-card); color: var(--text-muted); border-top: 1px solid var(--border); }
        
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: var(--text-main); color: var(--bg-card);
            padding: 0.75rem 1.5rem; border-radius: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 0.9rem; z-index: 200;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .toast.show { opacity: 1; }

        /* Estilo espec√≠fico para modal de Visi√≥n Global */
        #ai-global-content, #ai-global-modal .article-body, #ai-global-modal h2 {
            color: #1e293b !important;
        }
    </style>

    <script>
        const manifest = {
            "name": "Monitor Financiero AI",
            "short_name": "FinanzasAI",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0f172a",
            "theme_color": "#0f172a",
            "icons": [{ "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%236366f1'/%3E%3Cpath d='M368 128h80v256h-80v-256zM216 208h80v176h-80v-176zM64 288h80v96h-80v-96z' fill='white'/%3E%3C/svg%3E", "sizes": "192x192", "type": "image/svg+xml" }]
        };
        const link = document.createElement('link'); link.rel = 'manifest'; link.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(manifest)); document.head.appendChild(link);
    </script>
</head>
<body>

<!-- HEADER -->
<header>
    <div>
        <h1>Finanzas AI</h1>
        <div class="subtitle" id="last-update">Sin datos</div>
    </div>
    <div style="display: flex; gap: 0.5rem;">
        <button onclick="gemini.analyzeMarket()" class="ai-btn" aria-label="Visi√≥n Global">‚ú® Global</button>
        <button onclick="app.refreshFeed()" aria-label="Actualizar"><svg class="icon" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></button>
        <button onclick="ui.toggleSettings()" aria-label="Configuraci√≥n">‚öôÔ∏è</button>
    </div>
</header>

<!-- CONTENIDO PRINCIPAL -->
<main class="container">
    <!-- VISTA: NOTICIAS (FEED) -->
    <div id="view-feed">
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" id="search-input" class="search-input" placeholder="Buscar en internet (Enter)..." onkeydown="ui.handleSearch(event)">
        </div>
        <div id="news-container" class="news-list">
            <div class="loader">Cargando noticias financieras...</div>
        </div>
    </div>

    <!-- VISTA: GUARDADAS -->
    <div id="view-saved" class="hidden">
        <h3 style="margin-bottom:1rem;">üîñ Noticias Guardadas</h3>
        <div id="saved-container" class="news-list">
            <div class="loader">No hay noticias guardadas.</div>
        </div>
    </div>

    <!-- VISTA: GLOSARIO -->
    <div id="view-glossary" class="hidden">
        <h3 style="margin-bottom:1rem;">üìñ Glosario y Buscador de T√©rminos</h3>
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" id="term-search-input" class="search-input" placeholder="Define t√©rmino con IA (Enter)..." onkeydown="ui.handleTermSearch(event)">
        </div>
        <div id="glossary-list-container" class="news-list">
            <!-- Aqu√≠ van los t√©rminos -->
        </div>
    </div>
</main>

<!-- BOTTOM NAVIGATION -->
<nav class="bottom-nav">
    <button class="nav-item active" id="nav-feed" onclick="ui.switchView('feed')">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
        Noticias
    </button>
    <button class="nav-item" id="nav-saved" onclick="ui.switchView('saved')">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z"/></svg>
        Guardadas
    </button>
    <button class="nav-item" id="nav-glossary" onclick="ui.switchView('glossary')">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
        Glosario
    </button>
</nav>

<!-- MODAL: LECTOR -->
<div id="reader-modal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="ui.closeModal('reader-modal')">&times;</button>
        <h2 id="reader-title" style="margin-top: 2rem;">T√≠tulo</h2>
        <div id="reader-meta" class="meta" style="margin-bottom: 1rem;">Fuente ‚Ä¢ Fecha</div>

        <button id="btn-ai-analyze-article" class="ai-btn" style="width:100%; margin-bottom:1rem; justify-content:center;" onclick="gemini.analyzeArticle()">
            ‚ú® Inspector AI: An√°lisis + Glosario
        </button>

        <div id="ai-article-result" class="ai-analysis-box">
            <div class="ai-title">ü§ñ An√°lisis Inteligente</div>
            <div id="ai-article-content">Cargando an√°lisis...</div>
        </div>
        
        <div id="reader-body" class="article-body"></div>
        <div style="margin-top: 2rem; text-align: center;">
            <a id="reader-link" href="#" target="_blank" style="color: var(--primary); font-size: 0.9rem;">Ver fuente original completa &rarr;</a>
        </div>
    </div>
</div>

<!-- MODAL: T√âRMINO -->
<div id="term-modal" class="modal">
    <div class="modal-content" style="max-height: 50vh;">
        <button class="close-btn" onclick="ui.closeModal('term-modal')">&times;</button>
        <h3 id="term-modal-title" style="color: var(--primary); margin-top: 1rem; text-transform: capitalize;">T√©rmino</h3>
        <p id="term-modal-def" style="font-size: 1.1rem; color: var(--text-main);">Definici√≥n...</p>
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <button class="primary" onclick="ui.saveCurrentTerm()" style="flex:1;">üíæ Guardar en Glosario</button>
            <a id="term-google-link" href="#" target="_blank" style="flex:1; text-align:center; border:1px solid var(--border); border-radius:0.5rem; padding:0.5rem; text-decoration:none; color:var(--text-main);">üåç Buscar</a>
        </div>
    </div>
</div>

<!-- MODAL: VISI√ìN GLOBAL -->
<div id="ai-global-modal" class="modal">
    <div class="modal-content" style="background: linear-gradient(to bottom right, #f8fafc, #f3e8ff); min-height: 50vh;">
        <button class="close-btn" onclick="ui.closeModal('ai-global-modal')" style="background:white; color:#1e293b;">&times;</button>
        <h2 style="color: #6d28d9; display:flex; align-items:center; gap:0.5rem; margin-top: 1rem;">‚ú® Visi√≥n Global del Mercado</h2>
        <div id="ai-global-content" class="article-body" style="font-size:1rem;">
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:200px; color:#6d28d9;">
                <div class="loader" style="color:#6d28d9;">Analizando tendencias actuales...</div>
            </div>
        </div>
        <button class="primary" onclick="ui.closeModal('ai-global-modal')" style="margin-top:auto; align-self:center; width: 100%; max-width: 200px;">Cerrar Informe</button>
    </div>
</div>

<!-- MODAL: CONFIGURACI√ìN -->
<div id="settings-modal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="ui.closeModal('settings-modal')">&times;</button>
        <h2 style="margin-top: 1.5rem;">Configuraci√≥n</h2>
        <div class="config-group" style="background: #f3e8ff; padding: 10px; border-radius: 6px; border: 1px solid #d8b4fe;">
            <label style="color: #6b21a8;">‚ú® Gemini API Key</label>
            <input type="password" id="conf-gemini-key" class="config-input" placeholder="AIza...">
        </div>
        <div class="config-group">
            <label>API Key de NewsAPI</label>
            <input type="password" id="conf-apikey" class="config-input" placeholder="API Key...">
        </div>
        <button class="primary" type="button" onclick="config.saveFromUI()" style="width: 100%; margin-top: 1rem; font-weight:bold;">üíæ Guardar Configuraci√≥n</button>
    </div>
</div>

<div id="toast" class="toast">Mensaje</div>

<script>
const FINANCIAL_TERMS = {
    "EBITDA": "Beneficio bruto antes de deducibles.",
    "Yield": "Rentabilidad de una inversi√≥n (%).",
    "Short selling": "Apostar a que el precio baja.",
    "CDS": "Seguro contra impagos.",
    "BCE": "Banco Central Europeo.",
    "Fed": "Reserva Federal (EEUU).",
    "Bull market": "Mercado alcista (sube).",
    "Bear market": "Mercado bajista (baja).",
    "IPO": "Salida a bolsa.",
    "Default": "Impago."
};

// OBJETO ANALYZER (A√ëADIDO PARA EVITAR ERROR DE REFERENCIA)
const analyzer = {
    relevanceKeywords: ['BCE', 'Fed', 'Inflaci√≥n', 'Tipos', 'Crash', 'Recesi√≥n', 'Resultados', 'Dividendo', 'Fusi√≥n'],
    calculateRelevance: (text) => {
        if (!text) return 'Noticia general';
        const found = analyzer.relevanceKeywords.find(k => text.includes(k));
        return found ? `Relevante por: ${found}` : 'Noticia general';
    }
};

const config = {
    apiKey: localStorage.getItem('fin_apikey') || '',
    geminiKey: localStorage.getItem('fin_gemini_key') || '',
    sources: JSON.parse(localStorage.getItem('fin_sources')) || [
        { name: "Reuters", url: "https://feeds.reuters.com/reuters/businessNews", enabled: true, type: 'rss' },
        { name: "Financial Times", url: "https://www.ft.com/?format=rss", enabled: true, type: 'rss' },
        { name: "CNBC", url: "https://www.cnbc.com/id/10000664/device/rss/rss.html", enabled: true, type: 'rss' },
        { name: "El Economista", url: "https://www.eleconomista.es/rss/rss-portada.php", enabled: true, type: 'rss' }
    ],
    saveFromUI: () => {
        const k = document.getElementById('conf-apikey').value.trim();
        const g = document.getElementById('conf-gemini-key').value.trim();
        try {
            localStorage.setItem('fin_apikey', k); 
            localStorage.setItem('fin_gemini_key', g);
            config.apiKey = k; config.geminiKey = g;
            ui.showToast('¬°Claves guardadas!'); setTimeout(() => window.location.reload(), 1000);
        } catch(e) { alert("Error guardando."); }
    }
};

const gemini = {
    currentArticleText: "", 
    callAPI: async (prompt) => {
        if (!config.geminiKey) throw new Error("Falta API Key");
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${config.geminiKey}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        try {
            const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
            if (res.status === 429) throw new Error("QUOTA");
            if (!res.ok) throw new Error("API Error");
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text;
        } catch (e) { throw e; }
    },
    analyzeArticle: async () => {
        const resultBox = document.getElementById('ai-article-result');
        const contentBox = document.getElementById('ai-article-content');
        resultBox.style.display = 'block'; contentBox.innerHTML = 'üîç Analizando...';
        try {
            const res = await gemini.callAPI(`Analiza: "${gemini.currentArticleText.substring(0, 3000)}". HTML breve: <p><b>Resumen:</b>...</p><p><b>Sentimiento:</b>...</p>`);
            contentBox.innerHTML = res.replace(/```html/g, '').replace(/```/g, '');
        } catch (e) { contentBox.innerHTML = `<span style="color:orange">‚ö†Ô∏è IA no disponible (${e.message}).</span>`; }
    },
    analyzeMarket: async () => {
        const news = JSON.parse(localStorage.getItem('fin_cache_news') || '[]');
        if (news.length === 0) return ui.showToast("No hay noticias.");
        document.getElementById('ai-global-modal').classList.add('active');
        try {
            const res = await gemini.callAPI(`Resume mercado HTML: ${news.slice(0, 15).map(n=>n.title).join('\n')}`);
            document.getElementById('ai-global-content').innerHTML = res.replace(/```html/g, '').replace(/```/g, '');
        } catch (e) { document.getElementById('ai-global-content').innerHTML = "Error al conectar con IA."; }
    },
    defineTerm: async (term) => {
        try {
            return await gemini.callAPI(`Define el t√©rmino financiero "${term}" en 1 frase simple.`);
        } catch (e) { return "Definici√≥n no disponible (Error IA)."; }
    }
};

const fetcher = {
    searchAll: async (query) => {
        document.getElementById('news-container').innerHTML = '<div class="loader">Buscando...</div>';
        let allNews = [];
        if (config.apiKey) {
            try {
                const res = await fetch(`https://newsapi.org/v2/everything?q=${encodeURIComponent(query)}&language=es&sortBy=publishedAt&pageSize=15&apiKey=${config.apiKey}`);
                const data = await res.json();
                if(data.articles) allNews = data.articles.map(a => ({ title: a.title, url: a.url, source: a.source.name, date: a.publishedAt, summary: a.description||"", content: a.content }));
            } catch(e){}
        }
        try {
            const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(`https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=es-ES&gl=ES&ceid=ES:es`)}`);
            const data = await res.json();
            if(data.items) allNews = [...allNews, ...data.items.map(i => ({ title: i.title, url: i.link, source: "Google News", date: i.pubDate, summary: i.description?.replace(/<[^>]*>?/gm, '').substring(0,200), content: i.content }))];
        } catch(e){}
        
        allNews.sort((a,b) => new Date(b.date) - new Date(a.date));
        ui.renderNews(allNews);
    },
    getAllNews: async () => {
        document.getElementById('news-container').innerHTML = '<div class="loader">Actualizando...</div>';
        let allNews = [];
        if (config.apiKey) {
            try {
                const res = await fetch(`https://newsapi.org/v2/top-headlines?category=business&language=es&pageSize=20&apiKey=${config.apiKey}`);
                const data = await res.json();
                if(data.articles) allNews = data.articles.map(a => ({ title: a.title, url: a.url, source: a.source.name, date: a.publishedAt, summary: a.description||"", content: a.content }));
            } catch(e){}
        }
        await Promise.all(config.sources.map(async s => {
            try {
                const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(s.url)}&t=${Date.now()}`);
                const data = await res.json();
                if(data.items) allNews = [...allNews, ...data.items.map(i => ({ title: i.title, url: i.link, source: s.name, date: i.pubDate, summary: i.description?.replace(/<[^>]*>?/gm, '').substring(0,200), content: i.content }))];
            } catch(e){}
        }));
        
        allNews.sort((a,b) => new Date(b.date) - new Date(a.date));
        try {
            localStorage.setItem('fin_cache_news', JSON.stringify(allNews));
            localStorage.setItem('fin_last_update', Date.now());
        } catch(e) { console.error("Quota"); }
        ui.renderNews(allNews); 
    }
};

const ui = {
    currentTerm: { name: "", def: "" },
    currentView: 'feed',

    renderNews: (news) => {
        const container = document.getElementById('news-container');
        container.innerHTML = '';
        if (!news || news.length === 0) { container.innerHTML = '<div style="padding:2rem; text-align:center; color:var(--text-muted)">No hay noticias.</div>'; return; }
        
        const savedList = JSON.parse(localStorage.getItem('fin_saved_news')||'[]');
        
        news.forEach((item, idx) => {
            const isSaved = savedList.some(n=>n.url===item.url);
            // CRUCIAL: Usamos createElement para evitar errores de sintaxis con URLs complejas
            const card = document.createElement('div');
            card.className = 'news-card';
            
            // Bot√≥n Guardar
            const btn = document.createElement('button');
            btn.className = `bookmark-btn ${isSaved ? 'saved' : ''}`;
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="${isSaved?'M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z':'M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2zm0 15l-5-2.18L7 18V5h10v13z'}"/></svg>`;
            btn.onclick = (e) => ui.toggleBookmark(e, item.url);

            // Contenido
            const meta = document.createElement('div'); meta.className = 'meta';
            meta.innerHTML = `<span class="tag">${item.source}</span><span>${new Date(item.date).toLocaleDateString()}</span>`;
            
            const title = document.createElement('h3'); title.className = 'news-title'; title.textContent = item.title;
            const summary = document.createElement('div'); summary.className = 'news-summary'; summary.textContent = item.summary;
            const rel = document.createElement('span'); rel.className = 'relevance'; rel.textContent = analyzer.calculateRelevance(item.title + " " + item.summary);

            card.append(btn, meta, title, summary, rel);
            card.onclick = () => ui.openArticle(item);
            container.appendChild(card);
        });
    },

    toggleBookmark: (e, url) => {
        e.stopPropagation();
        let saved = JSON.parse(localStorage.getItem('fin_saved_news') || '[]');
        const news = (JSON.parse(localStorage.getItem('fin_cache_news') || '[]')).find(n => n.url === url) || saved.find(n=>n.url === url);
        
        if (saved.some(n => n.url === url)) { saved = saved.filter(n => n.url !== url); ui.showToast('Eliminada'); }
        else if (news) { saved.unshift(news); ui.showToast('Guardada'); }
        
        localStorage.setItem('fin_saved_news', JSON.stringify(saved));
        if(ui.currentView === 'saved') ui.renderSavedView(); 
        else {
            const feed = JSON.parse(localStorage.getItem('fin_cache_news') || '[]');
            ui.renderNews(feed);
        }
    },

    renderSavedView: () => {
        const saved = JSON.parse(localStorage.getItem('fin_saved_news') || '[]');
        const container = document.getElementById('saved-container');
        container.innerHTML = '';
        if (saved.length === 0) { container.innerHTML = '<div style="padding:2rem; text-align:center;">No tienes noticias guardadas.</div>'; return; }
        
        saved.forEach(item => {
            const card = document.createElement('div'); card.className = 'news-card';
            const btn = document.createElement('button'); btn.className = 'bookmark-btn saved';
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z"/></svg>`;
            btn.onclick = (e) => ui.toggleBookmark(e, item.url);
            
            const meta = document.createElement('div'); meta.className = 'meta'; meta.innerHTML = `<span class="tag">${item.source}</span>`;
            const title = document.createElement('h3'); title.innerText = item.title;
            
            card.append(btn, meta, title);
            card.onclick = () => ui.openArticle(item);
            container.appendChild(card);
        });
    },

    // --- GLOSARIO LOGIC ---
    handleTermSearch: async (e) => {
        if (e.key === 'Enter') {
            const query = e.target.value.trim().toLowerCase();
            if (!query) return ui.renderGlossary();

            const container = document.getElementById('glossary-list-container');
            container.innerHTML = '<div class="loader">Buscando...</div>';

            const saved = JSON.parse(localStorage.getItem('fin_saved_terms') || '[]');
            const foundSaved = saved.find(t => t.name.toLowerCase() === query);
            const baseDef = FINANCIAL_TERMS[Object.keys(FINANCIAL_TERMS).find(k => k.toLowerCase() === query)];

            let termData = null;
            if (foundSaved) termData = foundSaved;
            else if (baseDef) termData = { name: query, def: baseDef };
            else {
                container.innerHTML = '<div class="loader">Consultando IA...</div>';
                const aiDef = await gemini.defineTerm(query);
                termData = { name: query, def: aiDef };
            }

            container.innerHTML = '';
            const card = document.createElement('div'); card.className = 'term-card';
            card.innerHTML = `<div class="term-content"><div class="term-name">${termData.name}</div><div class="term-def">${termData.def}</div></div>`;
            const btn = document.createElement('button'); btn.className = 'primary'; btn.textContent = 'üíæ';
            btn.onclick = () => { ui.currentTerm = termData; ui.saveCurrentTerm(); };
            card.appendChild(btn);
            container.appendChild(card);
        }
    },

    saveCurrentTerm: () => {
        let saved = JSON.parse(localStorage.getItem('fin_saved_terms') || '[]');
        if (!saved.some(t => t.name.toLowerCase() === ui.currentTerm.name.toLowerCase())) {
            saved.unshift(ui.currentTerm);
            localStorage.setItem('fin_saved_terms', JSON.stringify(saved));
            ui.showToast('T√©rmino guardado');
            ui.closeModal('term-modal');
            if(ui.currentView === 'glossary') ui.renderGlossary();
        } else { ui.showToast('Ya existe'); }
    },

    deleteTerm: (name) => {
        let saved = JSON.parse(localStorage.getItem('fin_saved_terms') || '[]');
        saved = saved.filter(t => t.name !== name);
        localStorage.setItem('fin_saved_terms', JSON.stringify(saved));
        ui.renderGlossary();
    },

    renderGlossary: () => {
        const saved = JSON.parse(localStorage.getItem('fin_saved_terms') || '[]');
        const container = document.getElementById('glossary-list-container');
        container.innerHTML = '';
        if (saved.length === 0) { container.innerHTML = '<div style="padding:2rem; text-align:center; color:var(--text-muted)">Busca t√©rminos para guardarlos.</div>'; return; }
        
        saved.forEach(t => {
            const div = document.createElement('div'); div.className = 'term-card';
            div.innerHTML = `<div class="term-content"><div class="term-name">${t.name}</div><div class="term-def">${t.def}</div></div>`;
            const btn = document.createElement('button'); btn.className = 'delete-btn'; btn.innerHTML = 'üóëÔ∏è';
            btn.onclick = () => ui.deleteTerm(t.name);
            div.appendChild(btn);
            container.appendChild(div);
        });
    },

    // --- NAVEGACI√ìN ---
    switchView: (v) => {
        ui.currentView = v;
        ['feed','saved','glossary'].forEach(id => {
            document.getElementById(`view-${id}`).className = (id === v) ? '' : 'hidden';
            document.getElementById(`nav-${id}`).classList.toggle('active', id === v);
        });
        if (v === 'saved') ui.renderSavedView();
        if (v === 'glossary') ui.renderGlossary();
        if (v === 'feed') {
             const feed = JSON.parse(localStorage.getItem('fin_cache_news') || '[]');
             ui.renderNews(feed);
        }
    },

    // --- OTROS ---
    openArticle: (news) => {
        gemini.currentArticleText = `${news.title}. ${news.content || news.summary}`;
        document.getElementById('reader-title').textContent = news.title;
        document.getElementById('reader-meta').textContent = news.source;
        document.getElementById('reader-link').href = news.url;
        document.getElementById('ai-article-result').style.display = 'none';
        
        let safeText = (news.content || news.summary).replace(/</g, "&lt;");
        Object.keys(FINANCIAL_TERMS).forEach(term => {
            const regex = new RegExp(`\\b(${term})\\b`, 'gi');
            safeText = safeText.replace(regex, `<span class="highlight-term" data-term="${term}" onclick="ui.handleTermClick(this)">$1</span>`);
        });
        
        document.getElementById('reader-body').innerHTML = safeText;
        document.getElementById('reader-modal').classList.add('active');
    },
    
    handleTermClick: (el) => {
        const term = el.dataset.term;
        const def = FINANCIAL_TERMS[Object.keys(FINANCIAL_TERMS).find(k => k.toLowerCase() === term.toLowerCase())];
        if(def) {
            ui.currentTerm = { name: term, def: def };
            document.getElementById('term-modal-title').textContent = term;
            document.getElementById('term-modal-def').textContent = def;
            document.getElementById('term-google-link').href = `https://www.google.com/search?q=definicion+financiera+${term}`;
            document.getElementById('term-modal').classList.add('active');
        }
    },

    handleSearch: (e) => { if (e.key === 'Enter') fetcher.searchAll(e.target.value.trim()); },
    closeModal: (id) => document.getElementById(id).classList.remove('active'),
    toggleSettings: () => document.getElementById('settings-modal').classList.toggle('active'),
    showToast: (m) => { const t = document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
};

const app = {
    init: () => {
        try {
            const cached = localStorage.getItem('fin_cache_news');
            if (cached && JSON.parse(cached).length > 0) ui.renderNews(JSON.parse(cached));
            else app.refreshFeed();
        } catch(e) {
            console.log("Reset cache");
            localStorage.removeItem('fin_cache_news');
            app.refreshFeed();
        }
    },
    refreshFeed: () => fetcher.getAllNews()
};

window.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
